<!DOCTYPE html>  <html> <head>   <title>jquery.couch.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               jquery.couch.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>$.couch is used to communicate with a CouchDB server, the server methods can
be called directly without creating an instance. Typically all methods are
passed an <code>options</code> object which defines a success callback which
is called with the data returned from the http request to CouchDB, you can
find the other settings that can be used in the <code>options</code> object
from <a href="http://api.jquery.com/jQuery.ajax/#jQuery-ajax-settings">
jQuery.ajax settings</a></p>

<pre><code>$.couch.activeTasks({
  success: function (data) {
    console.log(data);
  }
});
</code></pre>

<p>Outputs (for example):</p>

<pre><code>[
  {
    "pid" : "&lt;0.11599.0&gt;",
    "status" : "Copied 0 of 18369 changes (0%)",
    "task" : "recipes",
    "type" : "Database Compaction"
  }
]
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">$</span><span class="p">.</span><span class="nx">couch</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">couch</span> <span class="o">||</span> <span class="p">{};</span>

  <span class="kd">function</span> <span class="nx">encodeDocId</span><span class="p">(</span><span class="nx">docID</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">docID</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;_design&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">parts</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
      <span class="k">return</span> <span class="s2">&quot;_design/&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">parts</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">docID</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">uuidCache</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">couch</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">urlPrefix</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>You can obtain a list of active tasks by using the <code>/_active_tasks</code> URL.
The result is a JSON array of the currently running tasks, with each task
being described with a single object.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">activeTasks</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">ajax</span><span class="p">(</span>
        <span class="p">{</span><span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">urlPrefix</span> <span class="o">+</span> <span class="s2">&quot;/_active_tasks&quot;</span><span class="p">},</span>
        <span class="nx">options</span><span class="p">,</span>
        <span class="s2">&quot;Active task status could not be retrieved&quot;</span>
      <span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Returns a list of all the databases in the CouchDB instance</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">allDbs</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">ajax</span><span class="p">(</span>
        <span class="p">{</span><span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">urlPrefix</span> <span class="o">+</span> <span class="s2">&quot;/_all_dbs&quot;</span><span class="p">},</span>
        <span class="nx">options</span><span class="p">,</span>
        <span class="s2">&quot;An error occurred retrieving the list of all databases&quot;</span>
      <span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>View and edit the CouchDB configuration, called with just the options
parameter the entire config is returned, you can be more specific by
passing the section and option parameters, if you specify a value that
value will be stored in the configuration.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">config</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">section</span><span class="p">,</span> <span class="nx">option</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="p">{</span><span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">urlPrefix</span> <span class="o">+</span> <span class="s2">&quot;/_config/&quot;</span><span class="p">};</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">section</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">url</span> <span class="o">+=</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">section</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">option</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">req</span><span class="p">.</span><span class="nx">url</span> <span class="o">+=</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">option</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;PUT&quot;</span><span class="p">;</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">toJSON</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">contentType</span> <span class="o">=</span> <span class="s2">&quot;application/json&quot;</span><span class="p">;</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">processData</span> <span class="o">=</span> <span class="kc">false</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">ajax</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span>
        <span class="s2">&quot;An error occurred retrieving/updating the server configuration&quot;</span>
      <span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Returns the session information for the currently logged in user.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">session</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
      <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">urlPrefix</span> <span class="o">+</span> <span class="s2">&quot;/_session&quot;</span><span class="p">,</span>
        <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;Accept&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nx">complete</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">resp</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">parseJSON</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">error</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;An error occurred getting session info: &quot;</span> <span class="o">+</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">},</span>

    <span class="nx">userDb</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">couch</span><span class="p">.</span><span class="nx">session</span><span class="p">({</span>
        <span class="nx">success</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">userDb</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">couch</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">authentication_db</span><span class="p">);</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">userDb</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Create a new user on the CouchDB server, <code>user_doc</code> is an
object with a <code>name</code> field and other information you want
to store relating to that user, for example
<code>{"name": "daleharvey"}</code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">signup</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user_doc</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>prepare user doc based on name and password</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">user_doc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">prepareUserDoc</span><span class="p">(</span><span class="nx">user_doc</span><span class="p">,</span> <span class="nx">password</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">couch</span><span class="p">.</span><span class="nx">userDb</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">db</span><span class="p">.</span><span class="nx">saveDoc</span><span class="p">(</span><span class="nx">user_doc</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Populates a user doc with a new password.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">prepareUserDoc</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user_doc</span><span class="p">,</span> <span class="nx">new_password</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">hex_sha1</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;creating a user doc requires sha1.js to be loaded in the page&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">user_prefix</span> <span class="o">=</span> <span class="s2">&quot;org.couchdb.user:&quot;</span><span class="p">;</span>
      <span class="nx">user_doc</span><span class="p">.</span><span class="nx">_id</span> <span class="o">=</span> <span class="nx">user_doc</span><span class="p">.</span><span class="nx">_id</span> <span class="o">||</span> <span class="nx">user_prefix</span> <span class="o">+</span> <span class="nx">user_doc</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">new_password</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>handle the password crypto</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">user_doc</span><span class="p">.</span><span class="nx">salt</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">couch</span><span class="p">.</span><span class="nx">newUUID</span><span class="p">();</span>
        <span class="nx">user_doc</span><span class="p">.</span><span class="nx">password_sha</span> <span class="o">=</span> <span class="nx">hex_sha1</span><span class="p">(</span><span class="nx">new_password</span> <span class="o">+</span> <span class="nx">user_doc</span><span class="p">.</span><span class="nx">salt</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">user_doc</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user_doc</span><span class="p">.</span><span class="nx">roles</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">user_doc</span><span class="p">.</span><span class="nx">roles</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">user_doc</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Authenticate against CouchDB, the <code>options</code> parameter is
expected to have <code>name</code> and <code>password</code> fields.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">login</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
      <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">urlPrefix</span> <span class="o">+</span> <span class="s2">&quot;/_session&quot;</span><span class="p">,</span> <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
        <span class="nx">data</span><span class="o">:</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">password</span><span class="p">},</span>
        <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;Accept&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nx">complete</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">resp</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">parseJSON</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">error</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;An error occurred logging in: &quot;</span> <span class="o">+</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Delete your current CouchDB user session</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">logout</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
      <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">urlPrefix</span> <span class="o">+</span> <span class="s2">&quot;/_session&quot;</span><span class="p">,</span> <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
        <span class="nx">username</span> <span class="o">:</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="nx">password</span> <span class="o">:</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
        <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;Accept&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nx">complete</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">resp</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">parseJSON</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">error</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;An error occurred logging out: &quot;</span> <span class="o">+</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>$.couch.db is used to communicate with a specific CouchDB database</p>

<pre><code>var $db = $.couch.db("mydatabase");
$db.allApps({
 success: function (data) {
   ... process data ...
 }
});
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">db</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">db_opts</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">db_opts</span> <span class="o">=</span> <span class="nx">db_opts</span> <span class="o">||</span> <span class="p">{};</span>
      <span class="kd">var</span> <span class="nx">rawDocs</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="kd">function</span> <span class="nx">maybeApplyVersion</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span> <span class="o">&amp;&amp;</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">_rev</span> <span class="o">&amp;&amp;</span> <span class="nx">rawDocs</span><span class="p">[</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
            <span class="nx">rawDocs</span><span class="p">[</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span><span class="p">].</span><span class="nx">rev</span> <span class="o">==</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">_rev</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>todo: can we use commonjs require here?</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">Base64</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;please include /_utils/script/base64.js in the page for &quot;</span> <span class="o">+</span>
                  <span class="s2">&quot;base64 support&quot;</span><span class="p">);</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">doc</span><span class="p">.</span><span class="nx">_attachments</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">_attachments</span> <span class="o">||</span> <span class="p">{};</span>
            <span class="nx">doc</span><span class="p">.</span><span class="nx">_attachments</span><span class="p">[</span><span class="s2">&quot;rev-&quot;</span><span class="o">+</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_rev</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">content_type</span> <span class="o">:</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
              <span class="nx">data</span> <span class="o">:</span> <span class="nx">Base64</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="nx">rawDocs</span><span class="p">[</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span><span class="p">].</span><span class="nx">raw</span><span class="p">)</span>
            <span class="p">};</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">};</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="nx">name</span><span class="o">:</span> <span class="nx">name</span><span class="p">,</span>
        <span class="nx">uri</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">urlPrefix</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Request compaction of the specified database.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">compact</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">{</span><span class="nx">successStatus</span><span class="o">:</span> <span class="mi">202</span><span class="p">});</span>
          <span class="k">return</span> <span class="nx">ajax</span><span class="p">({</span>
              <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">+</span> <span class="s2">&quot;_compact&quot;</span><span class="p">,</span>
              <span class="nx">data</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">processData</span><span class="o">:</span> <span class="kc">false</span>
            <span class="p">},</span>
            <span class="nx">options</span><span class="p">,</span>
            <span class="s2">&quot;The database could not be compacted&quot;</span>
          <span class="p">);</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Cleans up the cached view output on disk for a given view.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">viewCleanup</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">{</span><span class="nx">successStatus</span><span class="o">:</span> <span class="mi">202</span><span class="p">});</span>
          <span class="k">return</span> <span class="nx">ajax</span><span class="p">({</span>
              <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">+</span> <span class="s2">&quot;_view_cleanup&quot;</span><span class="p">,</span>
              <span class="nx">data</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">processData</span><span class="o">:</span> <span class="kc">false</span>
            <span class="p">},</span>
            <span class="nx">options</span><span class="p">,</span>
            <span class="s2">&quot;The views could not be cleaned up&quot;</span>
          <span class="p">);</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Compacts the view indexes associated with the specified design
document. You can use this in place of the full database compaction
if you know a specific set of view indexes have been affected by a
recent database change.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">compactView</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">groupname</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">{</span><span class="nx">successStatus</span><span class="o">:</span> <span class="mi">202</span><span class="p">});</span>
          <span class="k">return</span> <span class="nx">ajax</span><span class="p">({</span>
              <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">+</span> <span class="s2">&quot;_compact/&quot;</span> <span class="o">+</span> <span class="nx">groupname</span><span class="p">,</span>
              <span class="nx">data</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">processData</span><span class="o">:</span> <span class="kc">false</span>
            <span class="p">},</span>
            <span class="nx">options</span><span class="p">,</span>
            <span class="s2">&quot;The view could not be compacted&quot;</span>
          <span class="p">);</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Create a new database</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">create</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">{</span><span class="nx">successStatus</span><span class="o">:</span> <span class="mi">201</span><span class="p">});</span>
          <span class="k">return</span> <span class="nx">ajax</span><span class="p">({</span>
              <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">contentType</span><span class="o">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
              <span class="nx">data</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">processData</span><span class="o">:</span> <span class="kc">false</span>
            <span class="p">},</span>
            <span class="nx">options</span><span class="p">,</span>
            <span class="s2">&quot;The database could not be created&quot;</span>
          <span class="p">);</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Deletes the specified database, and all the documents and
attachments contained within it.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">drop</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">ajax</span><span class="p">(</span>
            <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">},</span>
            <span class="nx">options</span><span class="p">,</span>
            <span class="s2">&quot;The database could not be deleted&quot;</span>
          <span class="p">);</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Gets information about the specified database.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">info</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">ajax</span><span class="p">(</span>
            <span class="p">{</span><span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">},</span>
            <span class="nx">options</span><span class="p">,</span>
            <span class="s2">&quot;Database information could not be retrieved&quot;</span>
          <span class="p">);</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>$.couch.db.changes provides an API for subscribing to the changes
feed</p>

<pre><code>var $changes = $.couch.db("mydatabase").changes();
$changes.onChange = function (data) {
   ... process data ...
}
$changes.stop();
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">changes</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">since</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>

          <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>set up the promise object within a closure for this handler</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="kd">var</span> <span class="nx">timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">active</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">listeners</span> <span class="o">=</span> <span class="p">[],</span>
            <span class="nx">promise</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Add a listener callback</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="nx">onChange</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fun</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">listeners</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fun</span><span class="p">);</span>
              <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Stop subscribing to the changes feed</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="nx">stop</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">active</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
              <span class="p">}</span>
            <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>call each listener when there is a change</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="kd">function</span> <span class="nx">triggerListeners</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">listeners</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
            <span class="p">});</span>
          <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>when there is a change, call any listeners, then check for
another change</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">options</span><span class="p">.</span><span class="nx">success</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">active</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">since</span> <span class="o">=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">last_seq</span><span class="p">;</span>
              <span class="nx">triggerListeners</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
              <span class="nx">getChangesSince</span><span class="p">();</span>
            <span class="p">};</span>
          <span class="p">};</span>
          <span class="nx">options</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">active</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">getChangesSince</span><span class="p">,</span> <span class="nx">timeout</span><span class="p">);</span>
              <span class="nx">timeout</span> <span class="o">=</span> <span class="nx">timeout</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>actually make the changes request</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="kd">function</span> <span class="nx">getChangesSince</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">opts</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span><span class="nx">heartbeat</span> <span class="o">:</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">},</span> <span class="nx">options</span><span class="p">,</span> <span class="p">{</span>
              <span class="nx">feed</span> <span class="o">:</span> <span class="s2">&quot;longpoll&quot;</span><span class="p">,</span>
              <span class="nx">since</span> <span class="o">:</span> <span class="nx">since</span>
            <span class="p">});</span>
            <span class="nx">ajax</span><span class="p">(</span>
              <span class="p">{</span><span class="nx">url</span><span class="o">:</span> <span class="nx">db</span><span class="p">.</span><span class="nx">uri</span> <span class="o">+</span> <span class="s2">&quot;_changes&quot;</span><span class="o">+</span><span class="nx">encodeOptions</span><span class="p">(</span><span class="nx">opts</span><span class="p">)},</span>
              <span class="nx">options</span><span class="p">,</span>
              <span class="s2">&quot;Error connecting to &quot;</span><span class="o">+</span><span class="nx">db</span><span class="p">.</span><span class="nx">uri</span><span class="o">+</span><span class="s2">&quot;/_changes.&quot;</span>
            <span class="p">);</span>
          <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>start the first request</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span><span class="nx">since</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">getChangesSince</span><span class="p">();</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">db</span><span class="p">.</span><span class="nx">info</span><span class="p">({</span>
              <span class="nx">success</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">since</span> <span class="o">=</span> <span class="nx">info</span><span class="p">.</span><span class="nx">update_seq</span><span class="p">;</span>
                <span class="nx">getChangesSince</span><span class="p">();</span>
              <span class="p">}</span>
            <span class="p">});</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">promise</span><span class="p">;</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Fetch all the docs in this db, you can specify an array of keys to
fetch by passing the <code>keys</code> field in the
<code>options</code>
parameter.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">allDocs</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;GET&quot;</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;POST&quot;</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">];</span>
            <span class="k">delete</span> <span class="nx">options</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">];</span>
            <span class="nx">data</span> <span class="o">=</span> <span class="nx">toJSON</span><span class="p">({</span> <span class="s2">&quot;keys&quot;</span><span class="o">:</span> <span class="nx">keys</span> <span class="p">});</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">ajax</span><span class="p">({</span>
              <span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">,</span>
              <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span><span class="p">,</span>
              <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">+</span> <span class="s2">&quot;_all_docs&quot;</span> <span class="o">+</span> <span class="nx">encodeOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="nx">options</span><span class="p">,</span>
            <span class="s2">&quot;An error occurred retrieving a list of all documents&quot;</span>
          <span class="p">);</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Fetch all the design docs in this db</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">allDesignDocs</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">allDocs</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span>
            <span class="p">{</span><span class="nx">startkey</span><span class="o">:</span><span class="s2">&quot;_design&quot;</span><span class="p">,</span> <span class="nx">endkey</span><span class="o">:</span><span class="s2">&quot;_design0&quot;</span><span class="p">},</span> <span class="nx">options</span><span class="p">));</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Fetch all the design docs with an index.html, <code>options</code>
parameter expects an <code>eachApp</code> field which is a callback
called on each app found.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">allApps</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
          <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">eachApp</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">allDesignDocs</span><span class="p">({</span>
              <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">rows</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                  <span class="nx">self</span><span class="p">.</span><span class="nx">openDoc</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="p">{</span>
                    <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ddoc</span><span class="p">)</span> <span class="p">{</span>
                      <span class="kd">var</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">appPath</span><span class="p">,</span> <span class="nx">appName</span> <span class="o">=</span> <span class="nx">ddoc</span><span class="p">.</span><span class="nx">_id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
                      <span class="nx">appName</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
                      <span class="nx">appName</span> <span class="o">=</span> <span class="nx">appName</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
                      <span class="nx">index</span> <span class="o">=</span> <span class="nx">ddoc</span><span class="p">.</span><span class="nx">couchapp</span> <span class="o">&amp;&amp;</span> <span class="nx">ddoc</span><span class="p">.</span><span class="nx">couchapp</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
                      <span class="k">if</span> <span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">appPath</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">ddoc</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="nx">index</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
                      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">ddoc</span><span class="p">.</span><span class="nx">_attachments</span> <span class="o">&amp;&amp;</span>
                                 <span class="nx">ddoc</span><span class="p">.</span><span class="nx">_attachments</span><span class="p">[</span><span class="s2">&quot;index.html&quot;</span><span class="p">])</span> <span class="p">{</span>
                        <span class="nx">appPath</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">ddoc</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="s2">&quot;index.html&quot;</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
                      <span class="p">}</span>
                      <span class="k">if</span> <span class="p">(</span><span class="nx">appPath</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">eachApp</span><span class="p">(</span><span class="nx">appName</span><span class="p">,</span> <span class="nx">appPath</span><span class="p">,</span> <span class="nx">ddoc</span><span class="p">);</span>
                    <span class="p">}</span>
                  <span class="p">});</span>
                <span class="p">});</span>
              <span class="p">}</span>
            <span class="p">});</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Please provide an eachApp function for allApps()&quot;</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Returns the specified doc from the specified db.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">openDoc</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">docId</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">ajaxOptions</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">db_opts</span><span class="p">.</span><span class="nx">attachPrevRev</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">attachPrevRev</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">{</span>
              <span class="nx">beforeSuccess</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">rawDocs</span><span class="p">[</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="nx">rev</span> <span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">_rev</span><span class="p">,</span>
                  <span class="nx">raw</span> <span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span>
                <span class="p">};</span>
              <span class="p">}</span>
            <span class="p">});</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">{</span>
              <span class="nx">beforeSuccess</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">[</span><span class="s2">&quot;jquery.couch.attachPrevRev&quot;</span><span class="p">])</span> <span class="p">{</span>
                  <span class="nx">rawDocs</span><span class="p">[</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="nx">rev</span> <span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">_rev</span><span class="p">,</span>
                    <span class="nx">raw</span> <span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span>
                  <span class="p">};</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">});</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">ajax</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">+</span> <span class="nx">encodeDocId</span><span class="p">(</span><span class="nx">docId</span><span class="p">)</span> <span class="o">+</span> <span class="nx">encodeOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">)},</span>
            <span class="nx">options</span><span class="p">,</span>
            <span class="s2">&quot;The document could not be retrieved&quot;</span><span class="p">,</span>
            <span class="nx">ajaxOptions</span>
          <span class="p">);</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Create a new document in the specified database, using the supplied
JSON document structure. If the JSON structure includes the _id
field, then the document will be created with the specified document
ID. If the _id field is not specified, a new unique ID will be
generated.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">saveDoc</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
          <span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">beforeSend</span> <span class="o">=</span> <span class="nx">fullCommit</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">method</span> <span class="o">=</span> <span class="s2">&quot;POST&quot;</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">uri</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">method</span> <span class="o">=</span> <span class="s2">&quot;PUT&quot;</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">uri</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">+</span> <span class="nx">encodeDocId</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="kd">var</span> <span class="nx">versioned</span> <span class="o">=</span> <span class="nx">maybeApplyVersion</span><span class="p">(</span><span class="nx">doc</span><span class="p">);</span>
          <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="nx">uri</span> <span class="o">+</span> <span class="nx">encodeOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">),</span>
            <span class="nx">contentType</span><span class="o">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
            <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">toJSON</span><span class="p">(</span><span class="nx">doc</span><span class="p">),</span>
            <span class="nx">beforeSend</span> <span class="o">:</span> <span class="nx">beforeSend</span><span class="p">,</span>
            <span class="nx">complete</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">resp</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">parseJSON</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span> <span class="o">||</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">201</span> <span class="o">||</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">202</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span> <span class="o">=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
                <span class="nx">doc</span><span class="p">.</span><span class="nx">_rev</span> <span class="o">=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">rev</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">versioned</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">db</span><span class="p">.</span><span class="nx">openDoc</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="p">{</span>
                    <span class="nx">attachPrevRev</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                    <span class="nx">success</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
                      <span class="nx">doc</span><span class="p">.</span><span class="nx">_attachments</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">_attachments</span><span class="p">;</span>
                      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
                    <span class="p">}</span>
                  <span class="p">});</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
                <span class="p">}</span>
              <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">error</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;The document could not be saved: &quot;</span> <span class="o">+</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Save a list of documents</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">bulkSave</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">docs</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">beforeSend</span> <span class="o">=</span> <span class="nx">fullCommit</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
          <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">{</span><span class="nx">successStatus</span><span class="o">:</span> <span class="mi">201</span><span class="p">,</span> <span class="nx">beforeSend</span> <span class="o">:</span> <span class="nx">beforeSend</span><span class="p">});</span>
          <span class="k">return</span> <span class="nx">ajax</span><span class="p">({</span>
              <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
              <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">+</span> <span class="s2">&quot;_bulk_docs&quot;</span> <span class="o">+</span> <span class="nx">encodeOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">),</span>
              <span class="nx">contentType</span><span class="o">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">toJSON</span><span class="p">(</span><span class="nx">docs</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="nx">options</span><span class="p">,</span>
            <span class="s2">&quot;The documents could not be saved&quot;</span>
          <span class="p">);</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Deletes the specified document from the database. You must supply
the current (latest) revision and <code>id</code> of the document
to delete eg <code>removeDoc({_id:"mydoc", _rev: "1-2345"})</code></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">removeDoc</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">ajax</span><span class="p">({</span>
              <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">,</span>
              <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">+</span>
                   <span class="nx">encodeDocId</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span><span class="p">)</span> <span class="o">+</span>
                   <span class="nx">encodeOptions</span><span class="p">({</span><span class="nx">rev</span><span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">_rev</span><span class="p">})</span>
            <span class="p">},</span>
            <span class="nx">options</span><span class="p">,</span>
            <span class="s2">&quot;The document could not be deleted&quot;</span>
          <span class="p">);</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Remove a set of documents</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">bulkRemove</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">docs</span><span class="p">,</span> <span class="nx">options</span><span class="p">){</span>
          <span class="nx">docs</span><span class="p">.</span><span class="nx">docs</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span>
            <span class="nx">docs</span><span class="p">.</span><span class="nx">docs</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">doc</span><span class="p">){</span>
              <span class="nx">doc</span><span class="p">.</span><span class="nx">_deleted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">);</span>
          <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">{</span><span class="nx">successStatus</span><span class="o">:</span> <span class="mi">201</span><span class="p">});</span>
          <span class="k">return</span> <span class="nx">ajax</span><span class="p">({</span>
              <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
              <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">+</span> <span class="s2">&quot;_bulk_docs&quot;</span> <span class="o">+</span> <span class="nx">encodeOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">),</span>
              <span class="nx">data</span><span class="o">:</span> <span class="nx">toJSON</span><span class="p">(</span><span class="nx">docs</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="nx">options</span><span class="p">,</span>
            <span class="s2">&quot;The documents could not be deleted&quot;</span>
          <span class="p">);</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>The COPY command (which is non-standard HTTP) copies an existing
document to a new or existing document.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">copyDoc</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">docId</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">ajaxOptions</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">ajaxOptions</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ajaxOptions</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">complete</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">resp</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">parseJSON</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">201</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
              <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">error</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;The document could not be copied: &quot;</span> <span class="o">+</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">});</span>
          <span class="k">return</span> <span class="nx">ajax</span><span class="p">({</span>
              <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;COPY&quot;</span><span class="p">,</span>
              <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">+</span> <span class="nx">encodeDocId</span><span class="p">(</span><span class="nx">docId</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="nx">options</span><span class="p">,</span>
            <span class="s2">&quot;The document could not be copied&quot;</span><span class="p">,</span>
            <span class="nx">ajaxOptions</span>
          <span class="p">);</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Creates (and executes) a temporary view based on the view function
 supplied in the JSON request.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">query</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">mapFun</span><span class="p">,</span> <span class="nx">reduceFun</span><span class="p">,</span> <span class="nx">language</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">language</span> <span class="o">=</span> <span class="nx">language</span> <span class="o">||</span> <span class="s2">&quot;javascript&quot;</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">mapFun</span><span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">mapFun</span> <span class="o">=</span> <span class="nx">mapFun</span><span class="p">.</span><span class="nx">toSource</span> <span class="o">?</span> <span class="nx">mapFun</span><span class="p">.</span><span class="nx">toSource</span><span class="p">()</span>
              <span class="o">:</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">mapFun</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="p">{</span><span class="nx">language</span><span class="o">:</span> <span class="nx">language</span><span class="p">,</span> <span class="nx">map</span><span class="o">:</span> <span class="nx">mapFun</span><span class="p">};</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">reduceFun</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">reduceFun</span><span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span>
              <span class="nx">reduceFun</span> <span class="o">=</span> <span class="nx">reduceFun</span><span class="p">.</span><span class="nx">toSource</span> <span class="o">?</span> <span class="nx">reduceFun</span><span class="p">.</span><span class="nx">toSource</span><span class="p">()</span>
                <span class="o">:</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">reduceFun</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
            <span class="nx">body</span><span class="p">.</span><span class="nx">reduce</span> <span class="o">=</span> <span class="nx">reduceFun</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">ajax</span><span class="p">({</span>
              <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
              <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">+</span> <span class="s2">&quot;_temp_view&quot;</span> <span class="o">+</span> <span class="nx">encodeOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">),</span>
              <span class="nx">contentType</span><span class="o">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">toJSON</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="nx">options</span><span class="p">,</span>
            <span class="s2">&quot;An error occurred querying the database&quot;</span>
          <span class="p">);</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Fetch a _list view output, you can specify a list of
<code>keys</code> in the options object to recieve only those keys.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">list</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="nx">view</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">ajaxOptions</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">list</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
          <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;GET&#39;</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">[</span><span class="s1">&#39;keys&#39;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;POST&#39;</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="s1">&#39;keys&#39;</span><span class="p">];</span>
            <span class="k">delete</span> <span class="nx">options</span><span class="p">[</span><span class="s1">&#39;keys&#39;</span><span class="p">];</span>
            <span class="nx">data</span> <span class="o">=</span> <span class="nx">toJSON</span><span class="p">({</span><span class="s1">&#39;keys&#39;</span><span class="o">:</span> <span class="nx">keys</span> <span class="p">});</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">ajax</span><span class="p">({</span>
              <span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">,</span>
              <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span><span class="p">,</span>
              <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">+</span> <span class="s1">&#39;_design/&#39;</span> <span class="o">+</span> <span class="nx">list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
                   <span class="s1">&#39;/_list/&#39;</span> <span class="o">+</span> <span class="nx">list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">view</span> <span class="o">+</span> <span class="nx">encodeOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
              <span class="p">},</span>
              <span class="nx">ajaxOptions</span><span class="p">,</span> <span class="s1">&#39;An error occured accessing the list&#39;</span>
          <span class="p">);</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Execute an update function for a given document.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">updateDoc</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">updateFun</span><span class="p">,</span> <span class="nx">doc_id</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">ajaxOptions</span><span class="p">)</span> <span class="p">{</span>

	  <span class="kd">var</span> <span class="nx">ddoc_fun</span> <span class="o">=</span> <span class="nx">updateFun</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
	  <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
	  <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;PUT&#39;</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

	  <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
	    <span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">,</span>
	    <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span><span class="p">,</span>
            <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;Accept&#39;</span><span class="p">,</span> <span class="s1">&#39;*/*&#39;</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">complete</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">resp</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">201</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
              <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">error</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;An error occurred getting session info: &quot;</span> <span class="o">+</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
              <span class="p">}</span>
            <span class="p">},</span>
	    <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">+</span> <span class="s1">&#39;_design/&#39;</span> <span class="o">+</span> <span class="nx">ddoc_fun</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
	      <span class="s1">&#39;/_update/&#39;</span> <span class="o">+</span> <span class="nx">ddoc_fun</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">doc_id</span> <span class="o">+</span> <span class="nx">encodeOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
	  <span class="p">});</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Executes the specified view-name from the specified design-doc
design document, you can specify a list of <code>keys</code>
in the options object to recieve only those keys.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">view</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
          <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;GET&quot;</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">data</span><span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;POST&quot;</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">];</span>
            <span class="k">delete</span> <span class="nx">options</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">];</span>
            <span class="nx">data</span> <span class="o">=</span> <span class="nx">toJSON</span><span class="p">({</span> <span class="s2">&quot;keys&quot;</span><span class="o">:</span> <span class="nx">keys</span> <span class="p">});</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">ajax</span><span class="p">({</span>
              <span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">,</span>
              <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span><span class="p">,</span>
              <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">+</span> <span class="s2">&quot;_design/&quot;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
                   <span class="s2">&quot;/_view/&quot;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">encodeOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="nx">options</span><span class="p">,</span> <span class="s2">&quot;An error occurred accessing the view&quot;</span>
          <span class="p">);</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Fetch an arbitrary CouchDB database property</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">getDbProperty</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">propName</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">ajaxOptions</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">ajax</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">+</span> <span class="nx">propName</span> <span class="o">+</span> <span class="nx">encodeOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">)},</span>
            <span class="nx">options</span><span class="p">,</span>
            <span class="s2">&quot;The property could not be retrieved&quot;</span><span class="p">,</span>
            <span class="nx">ajaxOptions</span>
          <span class="p">);</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Set an arbitrary CouchDB database property</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">setDbProperty</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">propName</span><span class="p">,</span> <span class="nx">propValue</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">ajaxOptions</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">ajax</span><span class="p">({</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;PUT&quot;</span><span class="p">,</span>
            <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">+</span> <span class="nx">propName</span> <span class="o">+</span> <span class="nx">encodeOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">),</span>
            <span class="nx">data</span> <span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">propValue</span><span class="p">)</span>
          <span class="p">},</span>
            <span class="nx">options</span><span class="p">,</span>
            <span class="s2">&quot;The property could not be updated&quot;</span><span class="p">,</span>
            <span class="nx">ajaxOptions</span>
          <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">};</span>
    <span class="p">},</span>

    <span class="nx">encodeDocId</span><span class="o">:</span> <span class="nx">encodeDocId</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Accessing the root of a CouchDB instance returns meta information about
the instance. The response is a JSON structure containing information
about the server, including a welcome message and the version of the
server.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">info</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">ajax</span><span class="p">(</span>
        <span class="p">{</span><span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">urlPrefix</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="p">},</span>
        <span class="nx">options</span><span class="p">,</span>
        <span class="s2">&quot;Server information could not be retrieved&quot;</span>
      <span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Request, configure, or stop, a replication operation.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">replicate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">ajaxOptions</span><span class="p">,</span> <span class="nx">repOpts</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">repOpts</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span><span class="nx">source</span><span class="o">:</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">target</span><span class="o">:</span> <span class="nx">target</span><span class="p">},</span> <span class="nx">repOpts</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">repOpts</span><span class="p">.</span><span class="nx">continuous</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">repOpts</span><span class="p">.</span><span class="nx">cancel</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ajaxOptions</span><span class="p">.</span><span class="nx">successStatus</span> <span class="o">=</span> <span class="mi">202</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">ajax</span><span class="p">({</span>
          <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">urlPrefix</span> <span class="o">+</span> <span class="s2">&quot;/_replicate&quot;</span><span class="p">,</span>
          <span class="nx">data</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">repOpts</span><span class="p">),</span>
          <span class="nx">contentType</span><span class="o">:</span> <span class="s2">&quot;application/json&quot;</span>
        <span class="p">},</span>
        <span class="nx">ajaxOptions</span><span class="p">,</span>
        <span class="s2">&quot;Replication failed&quot;</span>
      <span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Fetch a new UUID</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">newUUID</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cacheNum</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cacheNum</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cacheNum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">uuidCache</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ajax</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">urlPrefix</span> <span class="o">+</span> <span class="s2">&quot;/_uuids&quot;</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="p">{</span><span class="nx">count</span><span class="o">:</span> <span class="nx">cacheNum</span><span class="p">},</span> <span class="nx">async</span><span class="o">:</span>
              <span class="kc">false</span><span class="p">},</span> <span class="p">{</span>
            <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">uuidCache</span> <span class="o">=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">uuids</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="s2">&quot;Failed to retrieve UUID batch.&quot;</span>
        <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">uuidCache</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="kd">function</span> <span class="nx">ajax</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">errorMessage</span><span class="p">,</span> <span class="nx">ajaxOptions</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">defaultAjaxOpts</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">contentType</span><span class="o">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
      <span class="nx">headers</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;Accept&quot;</span><span class="o">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>
    <span class="p">};</span>

    <span class="nx">options</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span><span class="nx">successStatus</span><span class="o">:</span> <span class="mi">200</span><span class="p">},</span> <span class="nx">options</span><span class="p">);</span>
    <span class="nx">ajaxOptions</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">defaultAjaxOpts</span><span class="p">,</span> <span class="nx">ajaxOptions</span><span class="p">);</span>
    <span class="nx">errorMessage</span> <span class="o">=</span> <span class="nx">errorMessage</span> <span class="o">||</span> <span class="s2">&quot;Unknown error&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
      <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">ajaxOptions</span> <span class="o">&amp;&amp;</span> <span class="nx">ajaxOptions</span><span class="p">.</span><span class="nx">headers</span><span class="p">){</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">header</span> <span class="k">in</span> <span class="nx">ajaxOptions</span><span class="p">.</span><span class="nx">headers</span><span class="p">){</span>
            <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="nx">header</span><span class="p">,</span> <span class="nx">ajaxOptions</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="nx">header</span><span class="p">]);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">complete</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">resp</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">parseJSON</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">alert</span><span class="p">(</span><span class="nx">errorMessage</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">ajaxStart</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">options</span><span class="p">.</span><span class="nx">ajaxStart</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="nx">options</span><span class="p">.</span><span class="nx">successStatus</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">beforeSuccess</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">beforeSuccess</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">resp</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">resp</span> <span class="o">&amp;&amp;</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">error</span> <span class="o">||</span>
                        <span class="nx">errorMessage</span><span class="p">,</span> <span class="nx">resp</span> <span class="o">&amp;&amp;</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">reason</span> <span class="o">||</span> <span class="s2">&quot;no response&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">alert</span><span class="p">(</span><span class="nx">errorMessage</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span> <span class="nx">obj</span><span class="p">),</span> <span class="nx">ajaxOptions</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">fullCommit</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">ensure_full_commit</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">commit</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">ensure_full_commit</span><span class="p">;</span>
      <span class="k">delete</span> <span class="nx">options</span><span class="p">.</span><span class="nx">ensure_full_commit</span><span class="p">;</span>
      <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;Accept&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">);</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">&quot;X-Couch-Full-Commit&quot;</span><span class="p">,</span> <span class="nx">commit</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
      <span class="p">};</span>
    <span class="p">}</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Convert a options object to an url query string.
ex: {key:'value',key2:'value2'} becomes '?key="value"&amp;key2="value2"'</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">encodeOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">buf</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">inArray</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span>
                      <span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;beforeSuccess&quot;</span><span class="p">,</span> <span class="s2">&quot;ajaxStart&quot;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">inArray</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="s2">&quot;startkey&quot;</span><span class="p">,</span> <span class="s2">&quot;endkey&quot;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">value</span> <span class="o">=</span> <span class="nx">toJSON</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">buf</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">value</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="s2">&quot;?&quot;</span> <span class="o">+</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">toJSON</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">obj</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">})(</span><span class="nx">jQuery</span><span class="p">);</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 